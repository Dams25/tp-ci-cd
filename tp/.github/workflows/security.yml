# ðŸ›¡ï¸ Security Scanning Pipeline
# Analyses de sÃ©curitÃ© automatiques et continues

name: ðŸ›¡ï¸ Security Scanning

on:
  # Scan automatique sur push et PR
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  
  # Scan programmÃ© (hebdomadaire)
  schedule:
    - cron: '0 2 * * 1'  # Tous les lundis Ã  2h00 UTC
  
  # DÃ©clenchement manuel
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - code-only
        - dependencies-only
        - docker-only

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # ðŸ” Job: Analyse statique du code (CodeQL)
  codeql-analysis:
    name: ðŸ” CodeQL Analysis
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type != 'dependencies-only' && github.event.inputs.scan_type != 'docker-only'
    
    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript' ]
        
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: ${{ matrix.language }}
          queries: +security-and-quality

      - name: ðŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: ðŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          category: "/language:${{matrix.language}}"

  # ðŸ“¦ Job: Analyse des dÃ©pendances
  dependency-analysis:
    name: ðŸ“¦ Dependency Analysis
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type != 'code-only' && github.event.inputs.scan_type != 'docker-only'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'tp/package-lock.json'

      - name: ðŸ“¦ Install dependencies
        working-directory: ./tp
        run: npm ci --audit

      - name: ðŸ›¡ï¸ Run npm audit
        working-directory: ./tp
        run: |
          npm audit --audit-level=moderate --json > npm-audit.json || true
          npm audit --audit-level=moderate

      - name: ðŸ” Dependency Review
        uses: actions/dependency-review-action@v3
        if: github.event_name == 'pull_request'

      - name: ðŸ›¡ï¸ Run Snyk security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=medium --file=tp/package.json
        continue-on-error: true

      - name: ðŸ“¤ Upload Snyk results
        if: always()
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: snyk.sarif
        continue-on-error: true

      - name: ðŸ“Š Generate dependency report
        if: always()
        run: |
          echo "## ðŸ“¦ Dependency Security Report" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ›¡ï¸ npm audit completed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Dependency review executed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ Snyk security scan performed" >> $GITHUB_STEP_SUMMARY

  # ðŸ³ Job: Analyse sÃ©curitÃ© Docker
  docker-security:
    name: ðŸ³ Docker Security Scan
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type != 'code-only' && github.event.inputs.scan_type != 'dependencies-only'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ”¨ Build Docker image for scanning
        uses: docker/build-push-action@v5
        with:
          context: ./tp
          file: ./tp/deployment/docker/Dockerfile
          tags: todolist-app:security-scan
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ðŸ›¡ï¸ Run Trivy container scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'todolist-app:security-scan'
          format: 'sarif'
          output: 'trivy-container.sarif'

      - name: ðŸ” Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './tp'
          format: 'sarif'
          output: 'trivy-fs.sarif'

      - name: ðŸ›¡ï¸ Run Trivy config scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: './tp/deployment'
          format: 'sarif'
          output: 'trivy-config.sarif'

      - name: ðŸ“¤ Upload Trivy scan results
        if: always()
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: |
            trivy-container.sarif
            trivy-fs.sarif
            trivy-config.sarif

      - name: ðŸ‹ Run Hadolint (Dockerfile linter)
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: ./tp/deployment/docker/Dockerfile
          format: sarif
          output-file: hadolint.sarif
          no-fail: true

      - name: ðŸ“¤ Upload Hadolint results
        if: always()
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: hadolint.sarif

      - name: ðŸ” Run Docker Bench Security
        run: |
          # Installation et exÃ©cution de Docker Bench Security
          git clone https://github.com/docker/docker-bench-security.git
          cd docker-bench-security
          sudo ./docker-bench-security.sh -l docker-bench.log || true

      - name: ðŸ“Š Generate Docker security report
        run: |
          echo "## ðŸ³ Docker Security Report" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ›¡ï¸ Trivy container scan completed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Trivy filesystem scan completed" >> $GITHUB_STEP_SUMMARY
          echo "- âš™ï¸ Trivy config scan completed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ‹ Hadolint Dockerfile analysis completed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Docker Bench Security executed" >> $GITHUB_STEP_SUMMARY

  # ðŸ” Job: Analyse des secrets
  secrets-analysis:
    name: ðŸ” Secrets Detection
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Run TruffleHog secrets scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

      - name: ðŸ” Run GitLeaks secrets scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: ðŸ“Š Generate secrets report
        run: |
          echo "## ðŸ” Secrets Detection Report" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” TruffleHog scan completed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” GitLeaks scan completed" >> $GITHUB_STEP_SUMMARY

  # ðŸ›¡ï¸ Job: Infrastructure as Code Security
  iac-security:
    name: ðŸ›¡ï¸ Infrastructure Security
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Run Checkov IaC scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: ./tp/deployment
          framework: dockerfile,yaml,github_actions
          output_format: sarif
          output_file_path: checkov.sarif

      - name: ðŸ“¤ Upload Checkov results
        if: always()
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: checkov.sarif

      - name: ðŸ” Run Ansible security scan
        working-directory: ./tp/deployment/ansible
        run: |
          # Installation et scan avec ansible-lint
          pip install ansible-lint
          ansible-lint --parseable --severity . > ansible-security.log || true
          
          # Analyse spÃ©cifique sÃ©curitÃ©
          grep -i "password\|secret\|key" . -r --include="*.yml" --include="*.yaml" > security-patterns.log || true

      - name: ðŸ“Š Generate IaC security report
        run: |
          echo "## ðŸ›¡ï¸ Infrastructure Security Report" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Checkov IaC scan completed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ­ Ansible security analysis completed" >> $GITHUB_STEP_SUMMARY

  # ðŸ“Š Job: AgrÃ©gation des rÃ©sultats de sÃ©curitÃ©
  security-summary:
    name: ðŸ“Š Security Summary
    runs-on: ubuntu-latest
    needs: [codeql-analysis, dependency-analysis, docker-security, secrets-analysis, iac-security]
    if: always()
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“Š Analyze security results
        id: security-analysis
        run: |
          # Analyse des rÃ©sultats de tous les scans de sÃ©curitÃ©
          CODEQL_STATUS="${{ needs.codeql-analysis.result }}"
          DEPS_STATUS="${{ needs.dependency-analysis.result }}"
          DOCKER_STATUS="${{ needs.docker-security.result }}"
          SECRETS_STATUS="${{ needs.secrets-analysis.result }}"
          IAC_STATUS="${{ needs.iac-security.result }}"
          
          echo "codeql_status=$CODEQL_STATUS" >> $GITHUB_OUTPUT
          echo "deps_status=$DEPS_STATUS" >> $GITHUB_OUTPUT
          echo "docker_status=$DOCKER_STATUS" >> $GITHUB_OUTPUT
          echo "secrets_status=$SECRETS_STATUS" >> $GITHUB_OUTPUT
          echo "iac_status=$IAC_STATUS" >> $GITHUB_OUTPUT
          
          # DÃ©terminer le niveau de sÃ©curitÃ© global
          FAILED_SCANS=0
          [[ "$CODEQL_STATUS" == "failure" ]] && ((FAILED_SCANS++))
          [[ "$DEPS_STATUS" == "failure" ]] && ((FAILED_SCANS++))
          [[ "$DOCKER_STATUS" == "failure" ]] && ((FAILED_SCANS++))
          [[ "$SECRETS_STATUS" == "failure" ]] && ((FAILED_SCANS++))
          [[ "$IAC_STATUS" == "failure" ]] && ((FAILED_SCANS++))
          
          if [ $FAILED_SCANS -eq 0 ]; then
            echo "security_level=HIGH" >> $GITHUB_OUTPUT
            echo "security_emoji=ðŸŸ¢" >> $GITHUB_OUTPUT
            echo "security_message=All security scans passed!" >> $GITHUB_OUTPUT
          elif [ $FAILED_SCANS -le 2 ]; then
            echo "security_level=MEDIUM" >> $GITHUB_OUTPUT
            echo "security_emoji=ðŸŸ¡" >> $GITHUB_OUTPUT
            echo "security_message=Some security issues detected" >> $GITHUB_OUTPUT
          else
            echo "security_level=LOW" >> $GITHUB_OUTPUT
            echo "security_emoji=ðŸ”´" >> $GITHUB_OUTPUT
            echo "security_message=Multiple security issues detected!" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“‹ Generate comprehensive security report
        run: |
          cat > security-report.md << EOF
          # ðŸ›¡ï¸ Comprehensive Security Report
          
          **Security Level:** ${{ steps.security-analysis.outputs.security_emoji }} ${{ steps.security-analysis.outputs.security_level }}
          **Scan Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          
          ## ðŸ“Š Security Scan Results
          
          | Scan Type | Status | Description |
          |-----------|--------|-------------|
          | ðŸ” CodeQL Analysis | ${{ needs.codeql-analysis.result }} | Static code analysis for vulnerabilities |
          | ðŸ“¦ Dependency Analysis | ${{ needs.dependency-analysis.result }} | Third-party dependency vulnerabilities |
          | ðŸ³ Docker Security | ${{ needs.docker-security.result }} | Container and image security scan |
          | ðŸ” Secrets Detection | ${{ needs.secrets-analysis.result }} | Leaked credentials and secrets |
          | ðŸ›¡ï¸ Infrastructure Security | ${{ needs.iac-security.result }} | Infrastructure as Code security |
          
          ## ðŸŽ¯ Security Recommendations
          
          ### High Priority
          - Review any failed security scans immediately
          - Update dependencies with known vulnerabilities
          - Rotate any exposed secrets or credentials
          
          ### Medium Priority
          - Implement additional security headers
          - Enable more strict linting rules
          - Set up automated security monitoring
          
          ### Continuous Improvement
          - Regular security training for team
          - Implement security champions program
          - Keep security tools and signatures updated
          
          ## ðŸ”— Resources
          - [Security Advisories](https://github.com/${{ github.repository }}/security/advisories)
          - [Dependabot Alerts](https://github.com/${{ github.repository }}/security/dependabot)
          - [Code Scanning Alerts](https://github.com/${{ github.repository }}/security/code-scanning)
          
          ---
          *This report was generated automatically by GitHub Actions*
          EOF

      - name: ðŸ“¤ Upload security report
        uses: actions/upload-artifact@v3
        with:
          name: security-report
          path: security-report.md
          retention-days: 90

      - name: ðŸš¨ Security notification
        if: steps.security-analysis.outputs.security_level == 'LOW'
        run: |
          echo "ðŸš¨ SECURITY ALERT: Multiple security issues detected!" >> $GITHUB_STEP_SUMMARY
          echo "Please review the security scan results immediately." >> $GITHUB_STEP_SUMMARY

      - name: ðŸ† Security summary
        run: |
          echo "## ðŸ›¡ï¸ Security Scan Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Security Level:** ${{ steps.security-analysis.outputs.security_emoji }} ${{ steps.security-analysis.outputs.security_level }}" >> $GITHUB_STEP_SUMMARY
          echo "**Message:** ${{ steps.security-analysis.outputs.security_message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Scan Results:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” **CodeQL Analysis:** ${{ needs.codeql-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ **Dependency Analysis:** ${{ needs.dependency-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ³ **Docker Security:** ${{ needs.docker-security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” **Secrets Detection:** ${{ needs.secrets-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ›¡ï¸ **Infrastructure Security:** ${{ needs.iac-security.result }}" >> $GITHUB_STEP_SUMMARY

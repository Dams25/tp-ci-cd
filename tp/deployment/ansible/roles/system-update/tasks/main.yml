# ==============================================================================
# RÃ”LE SYSTEM-UPDATE - MISE Ã€ JOUR ET PRÃ‰PARATION DU SYSTÃˆME
# ==============================================================================

---
- name: "ğŸ“¦ Mise Ã  jour du cache des paquets"
  apt:
    update_cache: yes
    cache_valid_time: 3600
  tags: ['system', 'update']

- name: "ğŸ”„ Mise Ã  jour complÃ¨te du systÃ¨me"
  apt:
    upgrade: dist
    autoremove: yes
    autoclean: yes
  register: system_upgrade
  tags: ['system', 'update']

- name: "ğŸ“‹ Affichage des paquets mis Ã  jour"
  debug:
    var: system_upgrade.stdout_lines
  when: system_upgrade.changed
  tags: ['system', 'update']

- name: "â° Configuration du fuseau horaire"
  timezone:
    name: "{{ timezone | default('Europe/Paris') }}"
  tags: ['system', 'timezone']

- name: "ğŸ“¦ Installation des paquets essentiels"
  apt:
    name: "{{ essential_packages }}"
    state: present
    update_cache: yes
  tags: ['system', 'packages']

- name: "ğŸ Installation de pip3"
  apt:
    name: python3-pip
    state: present
  tags: ['system', 'python']

- name: "ğŸ“¦ Installation des modules Python pour Ansible"
  pip:
    name: "{{ python_packages }}"
    state: present
    executable: pip3
  tags: ['system', 'python']

- name: "ğŸ” VÃ©rification si un redÃ©marrage est nÃ©cessaire"
  stat:
    path: /var/run/reboot-required
  register: reboot_required_file
  tags: ['system', 'reboot']

- name: "âš ï¸  Notification redÃ©marrage nÃ©cessaire"
  debug:
    msg: |
      ğŸ”„ ATTENTION: Un redÃ©marrage du systÃ¨me est recommandÃ© !
      ğŸ“ ExÃ©cutez: sudo reboot
      â° Ou utilisez: ansible-playbook ... -e "reboot_after_update=true"
  when: reboot_required_file.stat.exists
  tags: ['system', 'reboot']

- name: "ğŸ”„ RedÃ©marrage automatique (si activÃ©)"
  reboot:
    reboot_timeout: 300
    pre_reboot_delay: 10
    post_reboot_delay: 30
    msg: "ğŸ”„ RedÃ©marrage pour finaliser les mises Ã  jour systÃ¨me"
  when: 
    - reboot_required_file.stat.exists
    - reboot_after_update | default(false)
  tags: ['system', 'reboot']

- name: "âœ… VÃ©rification finale du systÃ¨me"
  command: uname -a
  register: system_info
  changed_when: false
  tags: ['system', 'verify']

- name: "ğŸ“Š Informations systÃ¨me aprÃ¨s mise Ã  jour"
  debug:
    msg: |
      ğŸ–¥ï¸  SystÃ¨me: {{ system_info.stdout }}
      ğŸ“… Mise Ã  jour terminÃ©e: {{ ansible_date_time.iso8601 }}
      âœ… SystÃ¨me prÃªt pour l'installation Docker
  tags: ['system', 'verify']

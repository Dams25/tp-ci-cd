# ==============================================================================
# RÃ”LE PRE-DEPLOYMENT - PRÃ‰PARATION ET SAUVEGARDE
# ==============================================================================

---
- name: "ğŸ“‹ VÃ©rification de l'Ã©tat actuel des services"
  block:
    - name: "ğŸ” VÃ©rification services Docker existants"
      command: "docker compose -f {{ app_directory }}/{{ compose_file }} ps --format json"
      register: current_services
      changed_when: false
      failed_when: false
      become_user: "{{ docker_user }}"
      
    - name: "ğŸ“Š Enregistrement Ã©tat actuel"
      set_fact:
        services_before_deploy: "{{ current_services.stdout | from_json if current_services.rc == 0 else [] }}"
        
    - name: "ğŸ” VÃ©rification version actuelle"
      shell: |
        if docker images --format "table {{.Repository}}:{{.Tag}}" | grep "{{ image_name }}"; then
          docker images --format "{{.Repository}}:{{.Tag}}" | grep "{{ image_name }}" | head -1
        else
          echo "none"
        fi
      register: current_version_check
      changed_when: false
      become_user: "{{ docker_user }}"
      
    - name: "ğŸ“ Enregistrement version prÃ©cÃ©dente"
      set_fact:
        previous_version: "{{ current_version_check.stdout | default('none') }}"
        
  tags: ['pre-deploy', 'status']

- name: "ğŸ’¾ Sauvegarde prÃ©-dÃ©ploiement"
  block:
    - name: "ğŸ“ CrÃ©ation rÃ©pertoire backup avec timestamp"
      file:
        path: "{{ backup_location }}/{{ deployment_timestamp }}"
        state: directory
        owner: "{{ docker_user }}"
        group: "{{ docker_group }}"
        mode: '0755'
      when: backup_before_deploy

    - name: "ğŸ’¾ Sauvegarde MongoDB si actif"
      block:
        - name: "ğŸ” VÃ©rification container MongoDB actif"
          command: docker ps --filter "name=mongodb" --format "{{.Names}}"
          register: mongodb_running
          changed_when: false
          become_user: "{{ docker_user }}"
          
        - name: "ğŸ“¦ Backup MongoDB"
          shell: |
            BACKUP_DIR="{{ backup_location }}/{{ deployment_timestamp }}"
            if docker ps --filter "name=mongodb" --format "{{.Names}}" | grep -q mongodb; then
              echo "ğŸ—„ï¸ Sauvegarde MongoDB en cours..."
              docker exec mongodb mongodump --out /tmp/backup_{{ deployment_timestamp }}
              docker cp mongodb:/tmp/backup_{{ deployment_timestamp }} "$BACKUP_DIR/mongodb_backup"
              docker exec mongodb rm -rf /tmp/backup_{{ deployment_timestamp }}
              echo "âœ… Sauvegarde MongoDB terminÃ©e"
            else
              echo "âš ï¸ Container MongoDB non trouvÃ©, sauvegarde ignorÃ©e"
            fi
          register: mongodb_backup_result
          become_user: "{{ docker_user }}"
          when: 
            - mongodb_backup
            - mongodb_running.stdout | length > 0
            
      when: backup_before_deploy
      tags: ['backup', 'mongodb']

    - name: "âš™ï¸ Sauvegarde configurations actuelles"
      block:
        - name: "ğŸ“‹ Sauvegarde docker-compose.yml actuel"
          copy:
            src: "{{ app_directory }}/{{ compose_file }}"
            dest: "{{ backup_location }}/{{ deployment_timestamp }}/docker-compose.yml.backup"
            remote_src: true
            owner: "{{ docker_user }}"
            group: "{{ docker_group }}"
            mode: '0644'
          when: backup_before_deploy
          ignore_errors: true
          
        - name: "ğŸ” Sauvegarde .env actuel"
          copy:
            src: "{{ app_directory }}/.env"
            dest: "{{ backup_location }}/{{ deployment_timestamp }}/.env.backup"
            remote_src: true
            owner: "{{ docker_user }}"
            group: "{{ docker_group }}"
            mode: '0600'
          when: backup_before_deploy
          ignore_errors: true
          
      tags: ['backup', 'config']

- name: "ğŸ§¹ PrÃ©paration espace disque"
  block:
    - name: "ğŸ’¾ VÃ©rification espace disque disponible"
      shell: "df -h {{ app_directory }} | awk 'NR==2 {print $5}' | sed 's/%//'"
      register: disk_usage
      changed_when: false
      
    - name: "âš ï¸ Alerte espace disque"
      debug:
        msg: |
          âš ï¸ ATTENTION: Espace disque utilisÃ© Ã  {{ disk_usage.stdout }}%
          ğŸ’¾ VÃ©rifiez l'espace disponible avant de continuer
      when: disk_usage.stdout | int > 80
      
    - name: "âŒ Ã‰chec si espace disque critique"
      fail:
        msg: "âŒ Espace disque critique ({{ disk_usage.stdout }}%). LibÃ©rez de l'espace avant de continuer."
      when: disk_usage.stdout | int > 95
      
    - name: "ğŸ§¹ Nettoyage prÃ©ventif images Docker obsolÃ¨tes"
      shell: |
        # Suppression images non taguÃ©es (danglingg)
        docker image prune -f
        
        # Garde uniquement les {{ keep_previous_versions }} derniÃ¨res versions
        if docker images {{ image_name }} --format "{{.Tag}}" | wc -l | awk '{print $1}' | xargs test $(cat) -gt {{ keep_previous_versions }}; then
          docker images {{ image_name }} --format "{{.Tag}}" | tail -n +$(({{ keep_previous_versions }} + 1)) | xargs -I {} docker rmi {{ image_name }}:{} || true
        fi
      register: cleanup_result
      become_user: "{{ docker_user }}"
      when: cleanup.remove_old_images
      tags: ['cleanup', 'disk']

- name: "ğŸ” Validation prÃ©-requis dÃ©ploiement"
  block:
    - name: "ğŸ“ VÃ©rification rÃ©pertoires requis"
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ docker_user }}"
        group: "{{ docker_group }}"
        mode: '0755'
      loop:
        - "{{ app_directory }}/logs"
        - "{{ app_directory }}/data"
        - "{{ app_directory }}/config"
        
    - name: "ğŸ” VÃ©rification variables secrets critiques"
      assert:
        that:
          - secrets.mongodb_root_password | length > 8
          - secrets.session_secret | length > 16
        fail_msg: "âŒ Variables secrets insuffisamment sÃ©curisÃ©es"
        success_msg: "âœ… Variables secrets validÃ©es"
        
    - name: "ğŸŒ Test connectivitÃ© rÃ©seau"
      wait_for:
        port: "{{ item }}"
        host: "localhost"
        timeout: 5
        state: stopped  # On vÃ©rifie que les ports sont libres
      loop:
        - "{{ app_port }}"
        - "{{ mongodb_port }}"
      ignore_errors: true
      
  tags: ['validation', 'pre-checks']

- name: "ğŸ“Š Rapport prÃ©-dÃ©ploiement"
  debug:
    msg: |
      ğŸ“‹ RAPPORT PRÃ‰-DÃ‰PLOIEMENT
      ========================
      ğŸ·ï¸ Version actuelle: {{ previous_version }}
      ğŸ¯ Version cible: {{ app_version }}
      ğŸ’¾ Espace disque: {{ disk_usage.stdout }}%
      ğŸ“¦ Services actifs: {{ services_before_deploy | length }}
      ğŸ’¾ Backup effectuÃ©: {{ 'Oui' if backup_before_deploy else 'Non' }}
      ğŸ”„ Rollback activÃ©: {{ 'Oui' if enable_rollback else 'Non' }}
      
      âœ… PrÃªt pour le dÃ©ploiement !
  tags: ['pre-deploy', 'report']

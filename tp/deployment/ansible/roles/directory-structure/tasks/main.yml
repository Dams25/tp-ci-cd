# ==============================================================================
# RÃ”LE DIRECTORY-STRUCTURE - CRÃ‰ATION STRUCTURE RÃ‰PERTOIRES
# ==============================================================================

---
- name: "ğŸ“ CrÃ©ation des rÃ©pertoires principaux de l'application"
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ docker_user }}"
    group: "{{ docker_group }}"
    mode: '0755'
  loop: "{{ directories_to_create }}"
  tags: ['directories', 'structure']

- name: "ğŸ“ CrÃ©ation du rÃ©pertoire de logs avec permissions spÃ©ciales"
  file:
    path: "/var/log/{{ app_name }}"
    state: directory
    owner: "{{ docker_user }}"
    group: "adm"
    mode: '0755'
  tags: ['directories', 'logs']

- name: "ğŸ”„ Configuration de la rotation des logs"
  template:
    src: logrotate.j2
    dest: "/etc/logrotate.d/{{ app_name }}"
    mode: '0644'
  tags: ['directories', 'logs']

- name: "ğŸ“‚ CrÃ©ation du rÃ©pertoire pour les sauvegardes"
  file:
    path: "{{ app_directory }}/backups"
    state: directory
    owner: "{{ docker_user }}"
    group: "{{ docker_group }}"
    mode: '0700'
  tags: ['directories', 'backup']

- name: "âš™ï¸  CrÃ©ation du rÃ©pertoire de configuration"
  file:
    path: "{{ app_directory }}/config"
    state: directory
    owner: "{{ docker_user }}"
    group: "{{ docker_group }}"
    mode: '0755'
  tags: ['directories', 'config']

- name: "ğŸ“Š CrÃ©ation du rÃ©pertoire de monitoring"
  file:
    path: "{{ app_directory }}/monitoring"
    state: directory
    owner: "{{ docker_user }}"
    group: "{{ docker_group }}"
    mode: '0755'
  when: monitoring_enabled | default(false)
  tags: ['directories', 'monitoring']

- name: "ğŸ—„ï¸  CrÃ©ation du rÃ©pertoire pour les donnÃ©es Docker volumes"
  file:
    path: "{{ app_directory }}/data/{{ item }}"
    state: directory
    owner: "{{ docker_user }}"
    group: "{{ docker_group }}"
    mode: '0755'
  loop:
    - mongodb
    - nginx
    - app
  tags: ['directories', 'volumes']

- name: "ğŸ“‹ CrÃ©ation d'un fichier README dans chaque rÃ©pertoire"
  copy:
    content: |
      # {{ item | basename | upper }} Directory
      
      Created by Ansible on {{ ansible_date_time.iso8601 }}
      Owner: {{ docker_user }}
      
      Purpose: {{ directory_purposes[item | basename] | default('Application directory') }}
      
      ## Structure
      ```
      {{ item }}/
      â”œâ”€â”€ README.md (this file)
      {% if item | basename == 'config' %}
      â”œâ”€â”€ .env                    # Environment variables
      â”œâ”€â”€ docker-compose.yml      # Docker composition
      â””â”€â”€ nginx/                  # Nginx configuration
      {% elif item | basename == 'data' %}
      â”œâ”€â”€ mongodb/                # MongoDB data
      â”œâ”€â”€ nginx/                  # Nginx data
      â””â”€â”€ app/                    # Application data
      {% elif item | basename == 'logs' %}
      â”œâ”€â”€ app.log                 # Application logs
      â”œâ”€â”€ nginx_access.log        # Nginx access logs
      â”œâ”€â”€ nginx_error.log         # Nginx error logs
      â””â”€â”€ mongodb.log             # MongoDB logs
      {% elif item | basename == 'backups' %}
      â”œâ”€â”€ daily/                  # Daily backups
      â”œâ”€â”€ weekly/                 # Weekly backups
      â””â”€â”€ scripts/                # Backup scripts
      {% elif item | basename == 'scripts' %}
      â”œâ”€â”€ deploy.sh               # Deployment script
      â”œâ”€â”€ backup.sh               # Backup script
      â””â”€â”€ maintenance.sh          # Maintenance script
      {% endif %}
      ```
      
      ## Permissions
      - Owner: {{ docker_user }}:{{ docker_group }}
      - Mode: 0755
      
      ## Maintenance
      Last updated: {{ ansible_date_time.iso8601 }}
    dest: "{{ item }}/README.md"
    owner: "{{ docker_user }}"
    group: "{{ docker_group }}"
    mode: '0644'
    force: false
  loop: "{{ directories_to_create }}"
  vars:
    directory_purposes:
      config: "Configuration files and environment variables"
      data: "Persistent data storage for containers"
      logs: "Application and system logs"
      backups: "Database and application backups"
      scripts: "Utility and maintenance scripts"
      monitoring: "Monitoring tools and configurations"
  tags: ['directories', 'documentation']

- name: "ğŸ”§ CrÃ©ation des scripts utilitaires de base"
  template:
    src: "{{ item.src }}"
    dest: "{{ app_directory }}/scripts/{{ item.dest }}"
    owner: "{{ docker_user }}"
    group: "{{ docker_group }}"
    mode: '0755'
  loop:
    - { src: 'backup.sh.j2', dest: 'backup.sh' }
    - { src: 'deploy.sh.j2', dest: 'deploy.sh' }
    - { src: 'maintenance.sh.j2', dest: 'maintenance.sh' }
  tags: ['directories', 'scripts']

- name: "ğŸ“Š VÃ©rification de la structure crÃ©Ã©e"
  command: "tree {{ app_directory }}"
  register: directory_tree
  changed_when: false
  ignore_errors: true
  tags: ['directories', 'verify']

- name: "ğŸ“‹ Affichage de la structure des rÃ©pertoires"
  debug:
    msg: |
      ğŸ“ Structure des rÃ©pertoires crÃ©Ã©e:
      {{ directory_tree.stdout | default('Tree command not available') }}
      
      âœ… RÃ©pertoires configurÃ©s avec succÃ¨s !
      ğŸ“ RÃ©pertoire principal: {{ app_directory }}
      ğŸ‘¤ PropriÃ©taire: {{ docker_user }}:{{ docker_group }}
  tags: ['directories', 'verify']

- name: "ğŸ’¾ VÃ©rification de l'espace disque disponible"
  shell: "df -h {{ app_directory }}"
  register: disk_space
  changed_when: false
  tags: ['directories', 'verify']

- name: "ğŸ’¾ Affichage de l'espace disque"
  debug:
    msg: |
      ğŸ’¾ Espace disque pour {{ app_directory }}:
      {{ disk_space.stdout }}
  tags: ['directories', 'verify']

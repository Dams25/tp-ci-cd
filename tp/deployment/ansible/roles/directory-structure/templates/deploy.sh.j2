#!/bin/bash
# ==============================================================================
# SCRIPT DE DÃ‰PLOIEMENT - {{ app_name | upper }}
# GÃ©nÃ©rÃ© automatiquement par Ansible
# ==============================================================================

set -e

# Variables
APP_DIR="{{ app_directory }}"
DOCKER_USER="{{ docker_user }}"
APP_NAME="{{ app_name }}"

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Fonction d'aide
show_help() {
    echo "Usage: $0 [start|stop|restart|status|update|logs|backup]"
    echo ""
    echo "Commands:"
    echo "  start     - DÃ©marrer l'application"
    echo "  stop      - ArrÃªter l'application"
    echo "  restart   - RedÃ©marrer l'application"
    echo "  status    - Afficher le statut"
    echo "  update    - Mettre Ã  jour l'application"
    echo "  logs      - Afficher les logs"
    echo "  backup    - Lancer une sauvegarde"
    echo "  help      - Afficher cette aide"
}

# VÃ©rifier si Docker est en cours d'exÃ©cution
check_docker() {
    if ! docker info &> /dev/null; then
        log_error "Docker n'est pas en cours d'exÃ©cution !"
        exit 1
    fi
}

# DÃ©marrer l'application
start_app() {
    log_info "ğŸš€ DÃ©marrage de l'application..."
    cd "$APP_DIR"
    docker-compose up -d
    log_success "âœ… Application dÃ©marrÃ©e"
}

# ArrÃªter l'application
stop_app() {
    log_info "ğŸ›‘ ArrÃªt de l'application..."
    cd "$APP_DIR"
    docker-compose down
    log_success "âœ… Application arrÃªtÃ©e"
}

# RedÃ©marrer l'application
restart_app() {
    log_info "ğŸ”„ RedÃ©marrage de l'application..."
    stop_app
    start_app
}

# Afficher le statut
show_status() {
    log_info "ğŸ“Š Statut de l'application:"
    cd "$APP_DIR"
    docker-compose ps
    echo ""
    log_info "ğŸ’¾ Utilisation des ressources:"
    docker stats --no-stream
}

# Mettre Ã  jour l'application
update_app() {
    log_info "ğŸ“¦ Mise Ã  jour de l'application..."
    cd "$APP_DIR"
    
    # Sauvegarde avant mise Ã  jour
    log_info "ğŸ”„ Sauvegarde avant mise Ã  jour..."
    "$APP_DIR/scripts/backup.sh"
    
    # Pull des nouvelles images
    docker-compose pull
    
    # RedÃ©marrage avec les nouvelles images
    docker-compose up -d --force-recreate
    
    log_success "âœ… Mise Ã  jour terminÃ©e"
}

# Afficher les logs
show_logs() {
    log_info "ğŸ“ Logs de l'application:"
    cd "$APP_DIR"
    docker-compose logs -f --tail=100
}

# Lancer une sauvegarde
run_backup() {
    log_info "ğŸ’¾ Lancement de la sauvegarde..."
    "$APP_DIR/scripts/backup.sh"
}

# VÃ©rifications prÃ©liminaires
check_docker

# Navigation par commande
case "${1:-help}" in
    start)
        start_app
        ;;
    stop)
        stop_app
        ;;
    restart)
        restart_app
        ;;
    status)
        show_status
        ;;
    update)
        update_app
        ;;
    logs)
        show_logs
        ;;
    backup)
        run_backup
        ;;
    help|*)
        show_help
        ;;
esac

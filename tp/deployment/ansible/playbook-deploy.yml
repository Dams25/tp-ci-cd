# ==============================================================================
# ANSIBLE PLAYBOOK - DÃ‰PLOIEMENT APPLICATION TODOLIST
# DÃ©ploiement zero-downtime avec rollback automatique et monitoring
# ==============================================================================

---
- name: "ğŸš€ DÃ©ploiement TodoList Production - Zero Downtime"
  hosts: docker_servers
  become: yes
  become_method: sudo
  gather_facts: yes
  serial: 1  # DÃ©ploiement un serveur Ã  la fois
  
  vars_files:
    - vars/deploy.yml
    - vars/infrastructure.yml
    - vars/security.yml
  
  vars:
    # Variables dynamiques
    deployment_timestamp: "{{ ansible_date_time.epoch }}"
    current_version: "{{ app_version | default('latest') }}"
    backup_required: "{{ mongodb_backup | default(true) }}"
    rollback_enabled: "{{ enable_rollback | default(true) }}"
    
  pre_tasks:
    - name: "ğŸ“‹ Validation des prÃ©requis de dÃ©ploiement"
      block:
        - name: "ğŸ” VÃ©rification de l'infrastructure Docker"
          command: docker --version
          register: docker_check
          failed_when: docker_check.rc != 0
          
        - name: "ğŸ” VÃ©rification Docker Compose"
          command: docker compose version
          register: compose_check
          failed_when: compose_check.rc != 0
          
        - name: "ğŸ“ VÃ©rification structure rÃ©pertoires"
          stat:
            path: "{{ app_directory }}"
          register: app_dir_check
          failed_when: not app_dir_check.stat.exists
          
        - name: "ğŸ‘¤ VÃ©rification utilisateur Docker"
          command: "groups {{ docker_user }}"
          register: user_groups
          failed_when: "'docker' not in user_groups.stdout"
          
        - name: "ğŸ•’ Affichage informations dÃ©ploiement"
          debug:
            msg: |
              ğŸš€ DÃ‰PLOIEMENT TODOLIST - {{ environment | upper }}
              ğŸ“… Timestamp: {{ deployment_timestamp }}
              ğŸ·ï¸  Version: {{ current_version }}
              ğŸ–¥ï¸  Serveur: {{ inventory_hostname }}
              ğŸ“ RÃ©pertoire: {{ app_directory }}
              ğŸ‘¤ Utilisateur: {{ docker_user }}
              ğŸ’¾ Backup MongoDB: {{ backup_required }}
              ğŸ”„ Rollback activÃ©: {{ rollback_enabled }}
      tags: ['validation', 'pre-deploy']
      
  roles:
    - role: deployment/pre-deployment
      tags: ['pre-deploy', 'backup']
      
    - role: deployment/file-transfer
      tags: ['transfer', 'files']
      
    - role: deployment/secrets-management
      tags: ['secrets', 'security']
      
    - role: deployment/docker-build
      tags: ['build', 'docker']
      
    - role: deployment/service-deployment
      tags: ['deploy', 'services']
      
    - role: deployment/health-checks
      tags: ['health', 'verify']
      
    - role: deployment/post-deployment
      tags: ['post-deploy', 'cleanup']
  
  post_tasks:
    - name: "âœ… RÃ©sumÃ© du dÃ©ploiement"
      debug:
        msg: |
          ğŸ‰ DÃ‰PLOIEMENT TERMINÃ‰ AVEC SUCCÃˆS !
          ğŸ·ï¸  Version dÃ©ployÃ©e: {{ current_version }}
          ğŸ•’ DurÃ©e: {{ ansible_date_time.epoch | int - deployment_timestamp | int }}s
          ğŸŒ Application: http://{{ inventory_hostname }}:{{ app_port | default(3000) }}
          ğŸ” Health check: http://{{ inventory_hostname }}:{{ app_port | default(3000) }}/health
          ğŸ“Š Statut services: {{ deployed_services | default('Tous actifs') }}
      when: deployment_success | default(true)
      
    - name: "ğŸ”” Notification de succÃ¨s"
      include_tasks: tasks/notifications.yml
      vars:
        notification_type: "success"
        message: "âœ… DÃ©ploiement {{ current_version }} rÃ©ussi sur {{ inventory_hostname }}"
      when: 
        - deployment_success | default(true)
        - notifications_enabled | default(false)
      tags: ['notifications']

  handlers:
    - name: restart application
      include_tasks: handlers/restart-app.yml
      
    - name: rollback deployment
      include_tasks: handlers/rollback.yml
      when: rollback_enabled | default(true)
      
    - name: send notification
      include_tasks: handlers/notifications.yml
      
    - name: cleanup resources
      include_tasks: handlers/cleanup.yml

# ==============================================================================
# GESTION D'ERREURS GLOBALE
# ==============================================================================
  rescue:
    - name: "âŒ Gestion d'erreur de dÃ©ploiement"
      block:
        - name: "ğŸ“ Enregistrement de l'erreur"
          debug:
            msg: |
              âŒ Ã‰CHEC DU DÃ‰PLOIEMENT !
              ğŸ·ï¸  Version: {{ current_version }}
              ğŸ–¥ï¸  Serveur: {{ inventory_hostname }}
              â° Timestamp: {{ ansible_date_time.iso8601 }}
              ğŸ” DÃ©tails: {{ ansible_failed_result | default('Erreur inconnue') }}
              
        - name: "ğŸ“§ Notification d'Ã©chec"
          include_tasks: tasks/notifications.yml
          vars:
            notification_type: "error"
            message: "âŒ Ã‰chec dÃ©ploiement {{ current_version }} sur {{ inventory_hostname }}"
          when: notifications_enabled | default(false)
          
        - name: "ğŸ”„ DÃ©clenchement rollback automatique"
          include_tasks: handlers/rollback.yml
          when: rollback_enabled | default(true)
          
        - name: "ğŸ“‹ GÃ©nÃ©ration rapport d'erreur"
          template:
            src: error-report.j2
            dest: "{{ app_directory }}/logs/deployment-error-{{ deployment_timestamp }}.log"
            owner: "{{ docker_user }}"
            group: "{{ docker_group }}"
            mode: '0644'
          
      always:
        - name: "ğŸ§¹ Nettoyage en cas d'erreur"
          include_tasks: handlers/cleanup.yml
